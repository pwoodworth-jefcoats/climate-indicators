---
title: "Indicator Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme:
      version: 4
      bg: "#FFFFFF"
      fg: "#000000" 
      primary: "#005AA8"
      
runtime: shiny
resource_files:
  - "Data/Dashboard_Data_2022.csv"
  - "Data/Dashboard_Map_Data_2022.csv"
  - "Data/rnatearth_coast.RData"
  - "Data/rnatearth_land.RData"
  - "Data/Dashboard_Map_Data_2022.csv"
  - "Images/Indicator-Table-2022-Monthly-Variables.png"
  - "Images/CO2-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/Chl-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/ENSO-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/MD50-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/PDO-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/SST-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/TatD-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/pH-Indicator-Table-2022-Monthly-Variables.png"
  - "Images/SST_map_2022.png"
  - "Images/TatD_map_2022.png"
  - "Images/Chl_map_2022.png"
  - "Images/MD50_map_2022.png"
  - "Descriptions/SST_description.md"
---

```{r setup, include = FALSE}
library(tidyverse)
library(flexdashboard)
library(shiny)
library(nmfspalette)
library(lubridate)
library(here)
library(plotly)
library(viridis)
library(htmltools)
library(rmarkdown)
library(shinyjs)
library(DT)
library(scales)
library(sf)
```

```{r}
here::i_am("IndicatorDashboard.Rmd")
```

```{r, include = FALSE, global = TRUE}
indicator_list <- c('Atmospheric Carbon Dioxide' = 'CO2',
                    'Oceanic pH' = 'pH',
                    'El Ni単o - Southern Oscillation' = 'ENSO',
                    'Pacific Decadal Oscillation' = 'PDO',
                    'Sea Surface Temperature' = 'SST',
                    'Temperature at Depth' = 'TatD',
                    'Ocean Color' = 'Chl', 
                    'Median Phytoplankton Size' = 'MD50')

include_anom_list <- c("SST", "CO2", "Chl", "MD50")
include_anom_map_list <- c("SST", "TatD", "Chl", "MD50")
exclude_ann_mean_list <- c("PDO", "ENSO")
report_year <- 2022

#set formatting parameters
plot_title_font <- list(size = 14)
plot_height <- 350 #in pixels
table_height <- 300 #in pixels

```

```{r, include = FALSE, global = TRUE}
### Access indicator data
# This will need to be built out to include additional indicators.
# For now, just testing the framework.

indicator_data <- read_csv(here('Data', 'Dashboard_Data_2022.csv'))
indicator_map_data <- read_csv(here('Data', 'Dashboard_Map_Data_2022.csv'))

#coastlines for maps
land_proj <- readRDS("Data/rnatearth_land.RData")
coast_proj <- readRDS("Data/rnatearth_coast.RData")

```

```{r, include = FALSE, global = TRUE}

# Create color palette for easy reference 
oceans <- nmfs_palette("oceans")(3) # 1 = report_year, 3 = previous years
crustacean <- nmfs_palette("crustacean")(4) # 1 = linear trend
coral <- nmfs_palette("coral")(3) # 3 = annual average for Rpt Yr
ann_grey <- "#D0D0D0" # annual means; in NMFS branding guide but not in package
waves <- nmfs_palette("waves")(3) # annual means; in NMFS branding guide but not in package
seagrass <- nmfs_palette("seagrass")(3)
#pal <- c(oceans[3], oceans[1], ann_grey, coral[3], crustacean[1])
pal <- c(oceans[3], oceans[1], waves[2], coral[3], crustacean[2]) #making some tweaks for visibility

```

Sidebar {.sidebar}
======================================================================
```{r}
# Select indicator to view
selectInput('indicator', label = 'Select an indicator', choices = indicator_list, selected = c('SST'))

```

The __Indicators at a Glance__ tab gives you a quick summary of all the available indicators.

The __Visualize Indicator__ tab provides a few data visualizations relevant to the indicator selected above.  

The __View Indicator Data__ tab lets you access the indicator time series data.

The __About the Indicator__ tab provides background information about the indicator along with some summary statistics.



This dashboard is designed to complement the Western Pacific Regional Fishery Management Council's [data portal](www.wpcouncildata.org/pelagicsafereport/), which includes the full suite of pelagic Climate and Oceanic Indicators and provides access to annual data.

Indicators at a Glance {style="position:relative;" data-orientation=columns}
======================================================================

Column
-----------------------------------------------------------------------

```{r}

output$summary_img <- renderImage({
  
  # Select image
  filename = here('Images', paste0(input$indicator, "-Indicator-Table-2022-Monthly-Variables.png"))
  height <- session$clientData$summary_img_height #dynamically adjust height 
  
  #Return a list containing filename and alt text
  list(src = filename,
       alt = "This is alternate text",
       width = "100%")

}, deleteFile = FALSE)

imageOutput("summary_img")

```

Visualize Indicator {style="position:relative;" data-orientation=columns}
======================================================================

Column {style="margin-right: 5px;"}
-----------------------------------------------------------------------

```{r}
output$ts <- renderPlotly({
  
  # Filter data
  indicator_data <- indicator_data |> filter(ID == input$indicator)
  
  if (input$indicator == "PDO"){
    
      indicator_data <- indicator_data |>
        mutate(Units = "Pacific Decal Oscillation (PDO)")
      
      #color-coded bar chart for PDO
      p1 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value, type = "bar", height = plot_height,
                    name = ~ifelse(Value > 0, yes = "Positive PDO", no = "Negative PDO"),
                    color = ~Value > 0, colors = c(oceans[2], coral[2]))
      
  } else if (input$indicator == "ENSO"){
    
      #calculate pos/neg/neutral ENSO values 
      indicator_data <- indicator_data |> mutate(Sign = sign(Value)) |>
        mutate(Sign = ifelse(test = (Value < 0.5 & Value > -0.5), yes = 0, no = Sign)) |>
        group_by(Sign, Group = with(rle(Sign), rep(seq_along(lengths), lengths))) |>
        ungroup() |>
        add_count(Group) |>
        mutate(ENSO = "Neutral") |>
        mutate(Units = "Oceanic Ni単o Index (ONI)")
    
      #add ENSO category
      indicator_data[which(indicator_data$Sign == -1 & indicator_data$n >= 5),]$ENSO <- "La Ni単a"
      indicator_data[which(indicator_data$Sign == 1 & indicator_data$n >= 5),]$ENSO <- "El Ni単o"

      #color-coded bar chart for ENSO
      p1 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value, type = "bar", height = plot_height, 
                    name = ~ENSO, color = ~ENSO, colors = c(coral[2], oceans[2], ann_grey))
    
  }
  else{
      # all other indicators - line chart
      # Calculate annual means 
      ann_vals <- indicator_data |>
      group_by(Year) |>
      summarise(Value = mean(Value, na.rm = TRUE))
      
      p1 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value,
                type = "scatter", mode = "lines", line = list(color = pal[1]),
                name = ~ID[1], height = 350) |>
      add_trace(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Value_lm,
               type = "scatter", mode = "lines", line = list(color = pal[5]),
               name = "Long-term Trend") |>
      add_trace(ann_vals, x = ymd_hm(paste(ann_vals$Year, '0601 00:00', sep = "")), y = ann_vals$Value,
               type = "scatter", mode = "lines", line = list(color = pal[3]),
               name = "Annual Mean")
  }

   #apply same layout for all plots
   p1 <- p1 |> layout(title = list(text = "Indicator Time Series", x = 0.01, font = plot_title_font), 
                      yaxis = list(title = indicator_data$Units[1], hoverformat = '.3f'),
                      paper_bgcolor='transparent',
                      plot_bgcolor='transparent',
                      hovermode = "x unified", 
                      hoverlabel = list(namelength = -1))
  
   p1
   
}) %>% bindCache(input$indicator)


div(style = "margin-top: 10px; margin-bottom: -50px;",
  plotlyOutput('ts')
)

```

<span style="color: #A5A5A5;">The __Time Series Plot__ shows monthly values for the indicator along with the annual average, or mean.  For variables with a significant and steady (or linear) long-term trend, this is shown as well.</span>

```{r}

output$anom_ts <- renderPlotly({
  
  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  
  # Calculate annual means
  ann_vals <- indicator_data |>
  group_by(Year) |>
  summarise(Anom = mean(Anom, na.rm = TRUE))

  
  p2 <- plot_ly(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Anom, height = plot_height,
                type = "scatter", mode = "lines", line = list(color = pal[1]),
                name = "Monthly Anomaly") |>
    add_trace(indicator_data, x = dmy_hm(indicator_data$Date_Time), y = ~Anom_lm,
              type = "scatter", mode = "lines", line = list(color = pal[5]),
              name = "Long-term Trend") |>
    add_trace(ann_vals, x = ymd_hm(paste(ann_vals$Year, '0601 00:00', sep = "")), y = ann_vals$Anom,
              type = "scatter", mode = "lines", line = list(color = pal[3]),
              name = "Annual Mean") |>
    layout(yaxis = list(title = indicator_data$Units[1], hoverformat = '.3f'),
           title = list(text = "Anomaly Time Series", x = 0.01, font = plot_title_font),
           paper_bgcolor='transparent',
           plot_bgcolor='transparent',
           hovermode = "x unified", 
           hoverlabel = list(namelength = -1))
  
  p2
  
}) %>% bindCache(input$indicator)

useShinyjs(rmd = TRUE)

observeEvent(input$indicator, {
  if (input$indicator %in% include_anom_list){
    shinyjs::showElement(id = "anom_ts")
  } else{
    shinyjs::hideElement(id = "anom_ts")
  }
})

plotlyOutput('anom_ts')

```

```{r}

output$anom_desc <- renderUI(
  
  markdown("<span style='color: #A5A5A5;'>The __Anomaly Time Series Plot__ show the time series and annual average, or mean, with the seasonal cycle removed.  For anomalies with a significant and steady (or linear) long-term trend, this is shown as well.</span>")
)

useShinyjs(rmd = TRUE)

observeEvent(input$indicator, {
  if (input$indicator %in% include_anom_list){
    shinyjs::showElement(id = "anom_desc")
  } else{
    shinyjs::hideElement(id = "anom_desc")
  }
})

uiOutput("anom_desc")

```

```{r warning = FALSE}

output$seasonal_cycle <- renderPlotly({
  
  #turn off uninformative plotly warning
  options(warn = -1)
  
  # Filter data
  indicator_data <- indicator_data |> filter(ID == input$indicator)
  
  #add month names and averages
  Seasonal <- indicator_data |> 
    mutate("Month_Abb" =  month.abb[Month]) |>
    group_by(Month) |>
    mutate(Mean_Val = mean(Value, na.rm = TRUE))
  
  p3_tmp <- Seasonal |>
    group_by(Month) |>
    group_map(~{plot_ly(.x, x = ~Year, y = ~Value, type = "scatter", color = ~Year, name = ~Month_Abb, height = plot_height,
                   colors = coral, mode = "markers+lines", line = list(color = pal[1], width = 1),
                   showlegend = FALSE) |>
         layout(yaxis = list(title = Seasonal$Units[1], hoverformat = '.3f'), 
                hovermode = "x unified", xaxis = list(title = ""), showlegend = TRUE) |>
         add_segments(x = min(Seasonal$Year), xend = max(Seasonal$Year), y = ~Mean_Val, yend = ~Mean_Val,
                line = list(color = "black", width = 2), name = "Monthly Mean", showlegend = (.y == 1)) |>
         colorbar(title = "Year", len = 0.7, x = 1, y = 0.8, limits = c(min(Seasonal$Year), max(Seasonal$Year)))}) |>
    subplot(nrows = 1, shareX = TRUE, shareY = TRUE, margin = 0.005) |>
    layout(title = list(text = "Seasonal Cycle Plot", x = 0.01, font = plot_title_font),
           paper_bgcolor='transparent',
           plot_bgcolor='transparent')
  
  #add titles - better way to do this?
  p3_tmp$x$layout$xaxis$title <- "Jan"
  p3_tmp$x$layout$xaxis2$title <- "Feb"
  p3_tmp$x$layout$xaxis3$title <- "Mar"
  p3_tmp$x$layout$xaxis4$title <- "Apr"
  p3_tmp$x$layout$xaxis5$title <- "May"
  p3_tmp$x$layout$xaxis6$title <- "Jun"
  p3_tmp$x$layout$xaxis7$title <- "Jul"
  p3_tmp$x$layout$xaxis8$title <- "Aug"
  p3_tmp$x$layout$xaxis9$title <- "Sep"
  p3_tmp$x$layout$xaxis10$title <- "Oct"
  p3_tmp$x$layout$xaxis11$title <- "Nov"
  p3_tmp$x$layout$xaxis12$title <- "Dec"
  
  p3_tmp
  
}) %>% bindCache(input$indicator)

div(style = "margin-top: 10px;",
  plotlyOutput('seasonal_cycle')
)

```

```{r}
# Inspiration: Melanie's OceanWatch figure where each year is plotted individually
output$seasonal_dots <- renderPlotly({

  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)

  #add month names
  Seasonal <- indicator_data |> group_by(Year) |> mutate("Month_Abb" =  month.abb[Month])
  
  #add month order
  xform <- list(title = "", categoryorder = "array", categoryarray = month.abb)

  p3 <- plot_ly(Seasonal, x = ~Month_Abb, y = ~Value, height = plot_height,
                type = 'scatter', mode = 'markers', color = ~Year, text = ~ID[1],
                hovertemplate = paste('<b>%{text}</b>: %{y}',
                                      '<br><b>Year</b>: %{marker.color}',
                                      '<extra></extra>')) |>
    layout(title = list(text = "Seasonal Points Plot", x = 0.01, font = plot_title_font), 
           paper_bgcolor='transparent',
           plot_bgcolor='transparent',
           yaxis = list(title = indicator_data$Units[1], hoverformat = '.3f'), xaxis = xform)
  
  p3

}) %>% bindCache(input$indicator)

div(style = "margin-top: -20px; margin-bottom: -40px",
  plotlyOutput('seasonal_dots')
)

```

<span style="color: #A5A5A5;">The __Seasonal Plots__ show the indicator values by month.  The cycle plot shows all the values for a given month in order by year.  The points plot stacks them vertically.</span>

```{r}
#knitr::include_graphics(here("Sea_Surface_Temperature","SST_map_2022.png"))

output$map <- renderPlotly({
  
  #filter plotting data
  raster_df <- indicator_map_data %>% filter(ID == input$indicator) 
  
  #set color scheme and plotting parameters based on indicator
  if (input$indicator == "SST"){
    pal <- rev(waves)
    ll_rect_color <- "white"   
    fill_scale <- scale_fill_gradientn(name = input$indicator, colors = pal)
  } else if (input$indicator == "TatD"){
    pal <- rev(waves)
    ll_rect_color <- "white"
    fill_scale <- scale_fill_gradientn(name = input$indicator, colors = pal)
  } else if (input$indicator == "Chl"){
    pal <- seagrass
    ll_rect_color <- "white"
    fill_scale <- scale_fill_gradientn(name = input$indicator, trans = log10_trans(),  
                                       colors = pal, limits = c(0.01, 10), oob = squish)
  } else if (input$indicator == "MD50"){
    pal <- seagrass
    ll_rect_color <- "black"
    fill_scale <- scale_fill_gradientn(name = input$indicator, colors = pal)
  }
  
  #report year map
  p <- ggplot() + 
    geom_raster(data = raster_df, mapping = aes(x=x, y=y, fill=layer, text = labels)) +
    geom_rect(aes(xmin = 0, xmax = 60, ymin = 15, ymax = 45), color = ll_rect_color, fill = NA, linewidth = 0.5)  +
    annotate("text", x = 30, y = 47, label = "Longline fishing grounds", size = 3.2, color = ll_rect_color) +
    fill_scale +
    geom_sf(data = land_proj, fill = "#A5A5A5", color = "#A5A5A5") +
    geom_sf(data = coast_proj) +
    coord_sf( expand = F) +
    xlab("") + ylab("") + 
    theme_bw() + theme(panel.grid = element_line(color="black", linewidth = 0.1),
                       legend.background = element_rect(fill='transparent'))
  
  g <- ggplotly(p, tooltip = c("labels"), height = plot_height) %>%
    layout(paper_bgcolor = 'transparent', plot_bgcolor = 'transparent') %>%
    style(hoverinfo = "skip", traces = c(3, 4))
  
  g
    
}) %>% bindCache(input$indicator)

plotlyOutput('map')

```

<span style="color: #A5A5A5;">This is some text about the __Map__</span>

```{r}
#knitr::include_graphics(here("Sea_Surface_Temperature","SST_map_2022.png"))

output$anom_map <- renderPlotly({
  
  #filter plotting data
  raster_anom_df <- indicator_map_data %>% filter(ID == paste0(input$indicator, "_anom")) 

  
  if (input$indicator == "Chl"){
    anom_fill_scale <- scale_fill_gradient2(name = input$indicator, low = oceans[2], 
                                            mid = "white", high = coral[2], oob = squish, 
                                            midpoint = 0, limits = c(-1, 1))
  } else{
    anom_fill_scale <- scale_fill_gradient2(name = input$indicator, low = oceans[2], 
                                            mid = "white", high = coral[2], midpoint = 0)
  }

  
  #report year map
  p_anom <- ggplot() + 
    geom_raster(data = raster_anom_df, mapping = aes(x=x, y=y, fill=layer, text = labels)) +
    geom_rect(aes(xmin = 0, xmax = 60, ymin = 15, ymax = 45), color = "black", fill = NA, linewidth = 0.5)  +
    annotate("text", x = 30, y = 47, label = "Longline fishing grounds", size = 3.2, color = "black") +
    anom_fill_scale +
    geom_sf(data = land_proj, fill = "#A5A5A5", color = "#A5A5A5") +
    geom_sf(data = coast_proj) +
    coord_sf(expand = F) +
    xlab("") + ylab("") +
    theme_bw() + theme(panel.grid = element_line(color="black", linewidth = 0.1),
                       legend.background = element_rect(fill='transparent'))
  
  g_anom <- ggplotly(p_anom, tooltip = c("labels"), height = plot_height) %>%
            layout(paper_bgcolor = 'transparent', plot_bgcolor = 'transparent') %>%
            style(hoverinfo = "skip", traces = c(3, 4))
  
  g_anom
    
}) %>% bindCache(input$indicator)

useShinyjs(rmd = TRUE)

observeEvent(input$indicator, {
  if (input$indicator %in% include_anom_map_list){
    shinyjs::showElement(id = "anom_map")
  } else{
    shinyjs::hideElement(id = "anom_map")
  }
})

plotlyOutput('anom_map')

```

<span style="color: #A5A5A5;">This is some text about the __Anomaly Map__</span>

View Indicator Data
======================================================================

Row
-----------------------------------------------------------------------

```{r}
output$time_series_table <- renderDT({
  
  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  
  # Just get the indicator columns
  IndicatorTimeSeries <- indicator_data %>% select(Date_Time, Value)
  
  # Rename the 'Value' column
  new_name <- paste(indicator_data$ID[1], 'in', indicator_data$Units[1], sep = ' ')
  names(IndicatorTimeSeries)[2] <- new_name

  IndicatorTimeSeries}, 
  selection = 'none',
  caption = htmltools::tags$caption(style = 'color:black; caption-side: top;', "Indicator Time Series Data:"),
  options = list(searching = FALSE, paging = TRUE, info = FALSE, lengthChange = FALSE,
                 columnDefs = list(list(className = 'dt-right', targets = c(1, 2))))
  
)

DTOutput("time_series_table", width = "90%", height = table_height)

```

Row
-----------------------------------------------------------------------

```{r}
# Create the actual downloadButton
output$downloadUI <- renderUI( {
  
  downloadButton("downBtn", "Download time series data", style = paste("width: 220px;",
                                                                       "background-color:", pal[1], ";",
                                                                       "border-color:", pal[1], ";",
                                                                       "align: right;",
                                                                       "margin: 0px 0px 8px 0px;",
                                                                       sep =""))
})

# Add download handling
output$downBtn <- downloadHandler(
  filename = function() {
    
    indicator_data <- indicator_data %>% filter(ID == input$indicator) 
    paste(indicator_data$ID[1], 'in', str_remove(indicator_data$Units[1], " "), Sys.Date(), '.csv', sep = '_')
    
  },
  content = function(file_out) {
    
    #select indicator of interest and export only time and value
    data_for_dl <- indicator_data %>% 
      filter(ID == input$indicator) %>% 
      select(Date_Time, Value)
    
    write.csv(data_for_dl, file_out, row.names = FALSE)
})

# Create placeholder for the downloadButton
uiOutput("downloadUI")

```

Row 
-----------------------------------------------------------------------

```{r}

output$anom_table <- renderDT({
  
  # Filter data
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  
  # Just get the indicator columns
  IndicatorTimeSeries <- indicator_data %>% select(Date_Time, Anom)
  
  IndicatorTimeSeries}, 
  selection = 'none',
  caption = htmltools::tags$caption(style = 'color:black; caption-side: top;', "Anomaly Time Series Data:"),
  options = list(searching = FALSE, paging = TRUE, info = FALSE, lengthChange = FALSE,
                 columnDefs = list(list(className = 'dt-right', targets = c(1, 2))))
  
)

useShinyjs(rmd = TRUE)

observeEvent(input$indicator, {
  if (input$indicator %in% include_anom_list){
    shinyjs::showElement(id = "anom_table")
  } else{
    shinyjs::hideElement(id = "anom_table")
  }
})


DTOutput("anom_table", width = "90%", height = table_height)

```

Row 
-----------------------------------------------------------------------

```{r}
# Create the actual downloadButton
output$downloadUIAnom <- renderUI( {
  
  downloadButton("downBtnAnom", "Download anomaly data", style = paste("width: 220px;",
                                                                       "background-color:", pal[1], ";",
                                                                       "border-color:", pal[1], ";",
                                                                       "align: right;",
                                                                       "margin: 0px 0px 8px 0px;",
                                                                       sep =""))
})

# Add download handling
output$downBtnAnom <- downloadHandler(
  filename = function() {
    indicator_data <- indicator_data %>% filter(ID == input$indicator)
    paste(indicator_data$ID[1], 'in', str_remove(indicator_data$Units[1], " "), Sys.Date(), 'Anomaly.csv', sep = '_')
  },
  content = function(file_out) {
    
    #select indicator of interest and export only time and value
    data_for_dl <- indicator_data %>% 
      filter(ID == input$indicator) %>% 
      select(Date_Time, Anom)
    
    write.csv(data_for_dl, file_out, row.names = FALSE)
})

useShinyjs(rmd = TRUE)

observeEvent(input$indicator, {
  if (input$indicator %in% include_anom_list){
    shinyjs::showElement(id = "downloadUIAnom")
  } else{
    shinyjs::hideElement(id = "downloadUIAnom")
  }
})

# Create placeholder for the downloadButton
uiOutput("downloadUIAnom")

```

About the Indicator
======================================================================

Row
-----------------------------------------------------------------------

### 2022 Average

```{r}

renderValueBox({
  
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  
  # Annual mean for report year
  if (input$indicator == "pH"){
    ann_mean_report_year <- indicator_data |> filter(Year == report_year - 1) |>
    summarise(Value = mean(Value, na.rm = TRUE)) |> signif(3)
    tmp_caption <- paste(as.character(report_year - 1), "Average")
  } else{
    ann_mean_report_year <- indicator_data |> filter(Year == report_year) |>
    summarise(Value = mean(Value, na.rm = TRUE)) |> signif(3) 
    tmp_caption <- paste(as.character(report_year), "Average")
  }
  
  valueBox(value = ann_mean_report_year, color = pal[1], caption = tmp_caption)
})
```

### 2022 Range

```{r}

renderValueBox({
  
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  
  # Monthly min & max for report year
  if (input$indicator == "pH"){
    monthly_min_report_year <- indicator_data |> filter(Year == report_year - 1) |>
      summarise(Value = min(Value, na.rm = TRUE)) |> signif(3) 
    monthly_max_report_year <- indicator_data |> filter(Year == report_year - 1) |>
      summarise(Value = max(Value, na.rm = TRUE)) |> signif(3) 
    tmp_caption <- paste(as.character(report_year - 1), "Range")
  } else{
    monthly_min_report_year <- indicator_data |> filter(Year == report_year) |>
      summarise(Value = min(Value, na.rm = TRUE)) |> signif(3) 
    monthly_max_report_year <- indicator_data |> filter(Year == report_year) |>
      summarise(Value = max(Value, na.rm = TRUE)) |> signif(3)
    tmp_caption <- paste(as.character(report_year), "Range")
  }
  
  valueBox(value = paste(monthly_min_report_year, "\u2013", monthly_max_report_year), color = pal[1], caption = tmp_caption)
})
```

### Long-Term Range

```{r}

renderValueBox({
  
  indicator_data <- indicator_data %>% filter(ID == input$indicator)
  
  # Monthly min & max for report year
  if (input$indicator == "pH"){
    # Monthly min & max for previous years
    monthly_min_PrevYrs <- indicator_data |> filter(Year < (report_year - 1)) |>
      summarise(Value = min(Value, na.rm = TRUE)) |> signif(3) 
    monthly_max_PrevYrs <- indicator_data |> filter(Year < (report_year - 1)) |>
      summarise(Value = max(Value, na.rm = TRUE)) |> signif(3) 
  } else{
    # Monthly min & max for previous years
    monthly_min_PrevYrs <- indicator_data |> filter(Year < report_year) |>
      summarise(Value = min(Value, na.rm = TRUE)) |> signif(3) 
    monthly_max_PrevYrs <- indicator_data |> filter(Year < report_year) |>
      summarise(Value = max(Value, na.rm = TRUE)) |> signif(3)  
  }

  valueBox(value = paste(monthly_min_PrevYrs, "\u2013", monthly_max_PrevYrs), color = pal[1])
})
```

Row
-----------------------------------------------------------------------

```{r}

Indicator_Description <- reactive({
  
  indicator_desc <- indicator_data %>% filter(ID == input$indicator)
  includeMarkdown(path = here('Descriptions', paste(indicator_desc$ID[1], '_description.md', sep = '')))
})

renderUI({Indicator_Description()}) #renderUI needed here instead of renderText

```
=======